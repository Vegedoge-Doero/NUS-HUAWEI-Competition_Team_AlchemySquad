clc; clear all;
%% Sample Stocks
filepath_sample = 'SampleStocks.csv';
symbols = readtable(filepath_sample).Code;
%%
clc;
filepath = './dataset/tickdata_20220805.csv';
subplot(3,2,1);
corr0805 = plotcorr(filepath, symbols, 0);
filepath = './dataset/tickdata_20220810.csv';
subplot(3,2,2);
corr0810 = plotcorr(filepath, symbols, 0);
filepath = './dataset/tickdata_20220811.csv';
subplot(3,2,3);
corr0811 = plotcorr(filepath, symbols, 0);
filepath = './dataset/tickdata_20220919.csv';
subplot(3,2,4);
corr0919 = plotcorr(filepath, symbols, 0);
filepath = './dataset/tickdata_20221111.csv';
subplot(3,2,5);
corr1111 = plotcorr(filepath, symbols, 1);
filepath = './dataset/tickdata_20221212.csv';
subplot(3,2,6);
corr1212 = plotcorr(filepath, symbols, 1);

%%
clc; 
listname = struct2cell(dir('./dataset/'));
listname = listname(1, 3:end);
ratioList = zeros(length(listname), 29);%class-1
for i = 1:length(listname)
    filepath = ['./dataset/', listname{i}];
    ratioList0 = distribution(filepath, symbols);
    ratioList(i, :) = ratioList0;
end
%%
clc;
colormap = [[16/256, 70/256, 128/256];...
            [27/256, 95/256, 155/256];...
            [49/256, 124/256, 183/256];...
            [79/256, 150/256, 196/256];...
            [109/256, 173/256, 209/256];...
            [140/256, 194/256, 220/256];...
            [182/256, 215/256, 232/256];...
            [205/256, 225/256, 238/256];...
            [233/256, 241/256, 244/256];...
            [242/256, 235/256, 230/256];...
            [251/256, 227/256, 213/256];...
            [248/256, 200/256, 180/256];...
            [246/256, 178/256, 147/256];...
            [232/256, 140/256, 117/256];...
            [220/256, 109/256, 87/256];...
            [200/256, 69/256, 62/256];...
            [183/256, 34/256, 48/256];...
            [140/256, 15/256, 40/256];...
            [109/256, 1/256, 31/256]];
colormap = imresize(colormap, [29,3]); 
ratio_mean = [];
for i=1:29 %class-1
plot(ratioList(:,i), 'LineWidth', 2.5, 'Color', colormap(i, :));
hold on;
ratio_mean = [ratio_mean, mean(ratioList(:,i))]
yline(ratio_mean(i), '-.', [num2str(ratio_mean(i)*100),'%'], 'Fontsize', 14,'LineWidth', 1.3, 'Color', [0 0 0]);
end
xlabel('File Date Index');
ylabel('[x(t) - VWAP] / x(t=0)');
set(gca,'FontName','Times New Roman','FontSize',18,'LineWidth',1.8);
ylim([-0.023, 0.02]);


%%
function corr = plotcorr(filepath, symbols, xticks)
data = readtable(filepath);
basis_string = {'Tick t', 'Open price', 'High p', 'Low p', 'Latest p', ...
    'Sell p1', 'Sell p2', 'Sell p3', 'Sell p4', 'Sell p5', 'Sell p6', 'Sell p7', 'Sell p8', 'Sell p9', 'Sell p10', ...
    'Sell v1', 'Sell v2', 'Sell v3', 'Sell v4', 'Sell v5', 'Sell v6', 'Sell v7', 'Sell v8', 'Sell v9', 'Sell v10', ...
    'Buy p1', 'Buy p2', 'Buy p3', 'Buy p4', 'Buy p5', 'Buy p6', 'Buy p7', 'Buy p8', 'Buy p9', 'Buy p10', ...
    'Buy v1', 'Buy v2', 'Buy v3', 'Buy v4', 'Buy v5', 'Buy v6', 'Buy v7', 'Buy v8', 'Buy v9', 'Buy v10', ...
    'Accumulated v', 'Accumulated p', 'Total buy v', 'Total sell v', 'Limit up p', 'Limit down p', 'VWAP buy', 'VWAP sell', 'Average p'};

dict = containers.Map;
DeltaT = 10;
T = 1000;
corr = zeros(T/DeltaT+1, 53);
for i=1:length(symbols)
    sym = symbols{i};
    idx = find(strcmp(sym, data.COLUMN02));
    dataMat = table2array(data(idx, 3:55));
    for l=1:size(dataMat,1)
        dataMat(l,54) = mean(dataMat(1:l, 5));
    end
    for j=1:53
        for k=0:DeltaT:T
            corr(k/DeltaT+1,j) = corr(k/DeltaT+1,j) + correlations(dataMat(k+1:end, 5), dataMat(1:end-k, j));
        end
    end
    dict(sym) = dataMat;
end
imagesc(corr./100);
ylabel('\Delta t');
if xticks == 1
    set(gca,'xtick',1:108);
    set(gca,'xticklabel',basis_string,'fontsize',12);
end
end

%%
function corr = correlations(A, B)
A = rescale(A, 0, 1);
B = rescale(B, 0, 1);
corr = (A'*B)/length(A)-(mean(A)*mean(B));
end

%% 
function ratioList30 = distribution(filepath, symbols)
data = readtable(filepath);
ratio = [];
for i=1:length(symbols)
    sym = symbols{i};
    idx = find(strcmp(sym, data.COLUMN02));
    dataMat = table2array(data(idx, [7, 48, 49]));
    VWAP = dataMat(end, 3) / dataMat(end, 2);
    ratio = [ratio, (dataMat(:, 1)' - VWAP*10000) / dataMat(1, 1)];  
end
ratio = sort(ratio);
ratioList20 = [ratio(1, round(length(ratio)*1/20)), ratio(1, round(length(ratio)*2/20)), ratio(1, round(length(ratio)*3/20)), ...
             ratio(1, round(length(ratio)*4/20)), ratio(1, round(length(ratio)*5/20)), ratio(1, round(length(ratio)*6/20)), ...
             ratio(1, round(length(ratio)*7/20)), ratio(1, round(length(ratio)*8/20)), ratio(1, round(length(ratio)*9/20)),...
             ratio(1, round(length(ratio)*10/20)), ratio(1, round(length(ratio)*11/20)), ratio(1, round(length(ratio)*12/20)), ...
             ratio(1, round(length(ratio)*13/20)), ratio(1, round(length(ratio)*14/20)), ratio(1, round(length(ratio)*15/20)), ...
             ratio(1, round(length(ratio)*16/20)), ratio(1, round(length(ratio)*17/20)), ratio(1, round(length(ratio)*18/20)), ratio(1, round(length(ratio)*19/20))];

ratioList30 = [ratio(1, round(length(ratio)*1/30)), ratio(1, round(length(ratio)*2/30)), ratio(1, round(length(ratio)*3/30)), ...
             ratio(1, round(length(ratio)*4/30)), ratio(1, round(length(ratio)*5/30)), ratio(1, round(length(ratio)*6/30)), ...
             ratio(1, round(length(ratio)*7/30)), ratio(1, round(length(ratio)*8/30)), ratio(1, round(length(ratio)*9/30)),...
             ratio(1, round(length(ratio)*10/30)), ratio(1, round(length(ratio)*11/30)), ratio(1, round(length(ratio)*12/30)), ...
             ratio(1, round(length(ratio)*13/30)), ratio(1, round(length(ratio)*14/30)), ratio(1, round(length(ratio)*15/30)), ...
             ratio(1, round(length(ratio)*16/30)), ratio(1, round(length(ratio)*17/30)), ratio(1, round(length(ratio)*18/30)), ...
             ratio(1, round(length(ratio)*19/30)), ratio(1, round(length(ratio)*20/30)), ratio(1, round(length(ratio)*21/30)), ...
             ratio(1, round(length(ratio)*22/30)), ratio(1, round(length(ratio)*23/30)), ratio(1, round(length(ratio)*24/30)), ...
             ratio(1, round(length(ratio)*25/30)), ratio(1, round(length(ratio)*26/30)), ratio(1, round(length(ratio)*27/30)), ...
             ratio(1, round(length(ratio)*28/30)), ratio(1, round(length(ratio)*29/30))];

ratioList15 = [ratio(1, round(length(ratio)*1/15)), ratio(1, round(length(ratio)*2/15)), ratio(1, round(length(ratio)*3/15)), ...
             ratio(1, round(length(ratio)*4/15)), ratio(1, round(length(ratio)*5/15)), ratio(1, round(length(ratio)*6/15)), ...
             ratio(1, round(length(ratio)*7/15)), ratio(1, round(length(ratio)*8/15)), ratio(1, round(length(ratio)*9/15)),...
             ratio(1, round(length(ratio)*10/15)), ratio(1, round(length(ratio)*11/15)), ratio(1, round(length(ratio)*12/15)), ...
             ratio(1, round(length(ratio)*13/15)), ratio(1, round(length(ratio)*14/15))];
ratioList12 = [ratio(1, round(length(ratio)*1/12)), ratio(1, round(length(ratio)*2/12)), ratio(1, round(length(ratio)*3/12)), ...
             ratio(1, round(length(ratio)*4/12)), ratio(1, round(length(ratio)*5/12)), ratio(1, round(length(ratio)*6/12)), ...
             ratio(1, round(length(ratio)*7/12)), ratio(1, round(length(ratio)*8/12)), ratio(1, round(length(ratio)*9/12)),...
             ratio(1, round(length(ratio)*10/12)), ratio(1, round(length(ratio)*11/12))];
ratioList10 = [ratio(1, round(length(ratio)*1/10)), ratio(1, round(length(ratio)*2/10)), ratio(1, round(length(ratio)*3/10)), ...
             ratio(1, round(length(ratio)*4/10)), ratio(1, round(length(ratio)*5/10)), ratio(1, round(length(ratio)*6/10)), ...
             ratio(1, round(length(ratio)*7/10)), ratio(1, round(length(ratio)*8/10)), ratio(1, round(length(ratio)*9/10))];
ratioList9 = [ratio(1, round(length(ratio)*1/9)), ratio(1, round(length(ratio)*2/9)), ratio(1, round(length(ratio)*3/9)), ...
             ratio(1, round(length(ratio)*4/9)), ratio(1, round(length(ratio)*5/9)), ratio(1, round(length(ratio)*6/9)), ...
             ratio(1, round(length(ratio)*7/9)), ratio(1, round(length(ratio)*8/9))];
ratioList8 = [ratio(1, round(length(ratio)*1/8)), ratio(1, round(length(ratio)*2/8)), ratio(1, round(length(ratio)*3/8)), ...
             ratio(1, round(length(ratio)*4/8)), ratio(1, round(length(ratio)*5/8)), ratio(1, round(length(ratio)*6/8)), ...
             ratio(1, round(length(ratio)*7/8))];
ratioList7 = [ratio(1, round(length(ratio)*1/7)), ratio(1, round(length(ratio)*2/7)), ratio(1, round(length(ratio)*3/7)), ...
             ratio(1, round(length(ratio)*4/7)), ratio(1, round(length(ratio)*5/7)), ratio(1, round(length(ratio)*6/7))];
ratioList6 = [ratio(1, round(length(ratio)*1/6)), ratio(1, round(length(ratio)*2/6)), ratio(1, round(length(ratio)*3/6)), ...
             ratio(1, round(length(ratio)*4/6)), ratio(1, round(length(ratio)*5/6))];
ratioList5 = [ratio(1, round(length(ratio)*1/5)), ratio(1, round(length(ratio)*2/5)), ratio(1, round(length(ratio)*3/10)), ...
             ratio(1, round(length(ratio)*4/5))];
ratioList4 = [ratio(1, round(length(ratio)*1/4)), ratio(1, round(length(ratio)*2/4)), ratio(1, round(length(ratio)*3/4))];
ratioList3 = [ratio(1, round(length(ratio)*1/3)), ratio(1, round(length(ratio)*2/3))];
end
